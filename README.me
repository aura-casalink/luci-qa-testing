# ğŸ§ª Luci QA Testing Suite

Sistema automatizado de testing para validar el funcionamiento del sistema de callbacks en el chatbot Luci across mÃºltiples dispositivos y navegadores.

## ğŸ¯ Objetivo

Detectar y prevenir fallos en el sistema de callbacks que causan que los mensajes lleguen a Supabase pero no se muestren en el frontend, especialmente en Safari mÃ³vil y otros dispositivos con limitaciones de WebSocket.

## ğŸ—ï¸ Arquitectura del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Playwright    â”‚â”€â”€â”€â”€â”‚   Frontend   â”‚â”€â”€â”€â”€â”‚   Supabase      â”‚
â”‚   Test Runner   â”‚    â”‚   (Luci)     â”‚    â”‚   (Callbacks)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚                      â”‚
         â”‚                      â”‚                      â”‚
         â–¼                      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Multi-device  â”‚    â”‚   Realtime   â”‚    â”‚   Polling       â”‚
â”‚   Testing       â”‚    â”‚   WebSocket  â”‚    â”‚   Fallback      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ InstalaciÃ³n RÃ¡pida

```bash
# 1. Navegar a la carpeta de testing
cd qa-testing/

# 2. Instalar dependencias
npm install

# 3. Instalar navegadores de Playwright
npm run install-browsers

# 4. Ejecutar test rÃ¡pido
npm run test:quick
```

## ğŸ“‹ Tipos de Tests

### ğŸƒ Quick Tests
Tests bÃ¡sicos en Chrome Desktop para validaciÃ³n rÃ¡pida.
```bash
node scripts/run-qa.js quick
npm test
```

### ğŸŒ Full Tests
Tests completos en todos los dispositivos y navegadores.
```bash
node scripts/run-qa.js full
node scripts/run-qa.js full --headed  # Con navegador visible
```

### ğŸ“ˆ Monitoring Tests
Tests de monitorizaciÃ³n continua para detectar degradaciÃ³n.
```bash
node scripts/run-qa.js monitoring --report
```

### ğŸ’ª Stress Tests
Tests de stress y casos extremos.
```bash
node scripts/run-qa.js stress --debug
```

## ğŸ”§ ConfiguraciÃ³n

### Variables de Entorno
Crear archivo `.env` en `qa-testing/`:
```env
# URLs
BASE_URL=https://lucy-chatbot.vercel.app
CALLBACK_WEBHOOK=https://lucy-chatbot.vercel.app/api/callback

# Supabase (ya incluidas en el cÃ³digo)
SUPABASE_URL=https://uxyxxhsgkprnuxohjhbc.supabase.co
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Timeouts (opcional)
CALLBACK_TIMEOUT=30000
PAGE_LOAD_TIMEOUT=15000
```

### Dispositivos Testados

| CategorÃ­a | Dispositivo | Navegador | Viewport |
|-----------|-------------|-----------|----------|
| **Desktop** | Chrome | Chromium | 1280x720 |
| **Desktop** | Firefox | Firefox | 1280x720 |
| **Desktop** | Safari | WebKit | 1280x720 |
| **Mobile** | Pixel 7 | Chrome | 412x915 |
| **Mobile** | iPhone 14 | Safari | 390x844 |
| **Mobile** | iPhone 14 Pro Max | Safari | 430x932 |
| **Mobile** | Galaxy S9+ | Chrome | 320x658 |
| **Tablet** | iPad Pro | Safari | 1024x1366 |
| **Tablet** | Galaxy Tab S4 | Chrome | 712x1138 |

## ğŸ§© Estructura del Proyecto

```
qa-testing/
â”œâ”€â”€ package.json              # Dependencias y scripts
â”œâ”€â”€ playwright.config.js      # ConfiguraciÃ³n de Playwright
â”œâ”€â”€ README.md                 # Esta documentaciÃ³n
â”œâ”€â”€
â”œâ”€â”€ config/
â”‚   â””â”€â”€ test-config.js        # ConfiguraciÃ³n global de tests
â”œâ”€â”€
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ test-helpers.js       # Funciones auxiliares
â”œâ”€â”€
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ callback-qa.test.js   # Tests principales de callback
â”‚   â”œâ”€â”€ stress-test.test.js   # Tests de stress
â”‚   â””â”€â”€ monitoring.test.js    # Tests de monitorizaciÃ³n
â”œâ”€â”€
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ run-qa.js            # Script principal de ejecuciÃ³n
â”œâ”€â”€
â””â”€â”€ reports/                 # Reportes generados
    â”œâ”€â”€ test-results/        # Resultados JSON
    â”œâ”€â”€ playwright-report/   # Reportes HTML
    â””â”€â”€ qa-reports/         # Reportes personalizados
```

## ğŸ” CÃ³mo Funciona

### 1. Flujo Principal del Test
```mermaid
sequenceDiagram
    participant T as Test
    participant P as Page
    participant S as Supabase
    participant F as Frontend
    
    T->>P: Cargar pÃ¡gina
    T->>P: Activar modo test
    T->>S: Insertar callback
    P->>S: SuscripciÃ³n Realtime
    S->>P: Callback via WebSocket
    P->>F: Mostrar propiedades
    T->>P: Verificar UI
    T->>S: Marcar como procesado
```

### 2. Sistema de Fallback
Si Realtime falla (especialmente en Safari mÃ³vil):
1. **Polling automÃ¡tico** cada 6 segundos
2. **Timeout** de 3 minutos
3. **VerificaciÃ³n dual**: UI + Supabase

### 3. DetecciÃ³n de Errores
- **Logs de consola** capturados en tiempo real
- **Screenshots** automÃ¡ticos en fallos
- **MÃ©tricas de rendimiento** registradas
- **AnÃ¡lisis de causas** incluido en reportes

## ğŸ“Š InterpretaciÃ³n de Resultados

### âœ… Test Exitoso
```
âœ… Ã‰XITO: 2 propiedades mostradas correctamente
âœ“ Loading state activado
âœ“ Callback insertado en Supabase con ID: 123
âœ“ Loading desapareciÃ³: true
âœ“ Callback procesado en Supabase: true
```

### âŒ Test Fallido
```
âŒ FALLO EN UI: Callback no apareciÃ³ en UI: timeout
Session ID: qa_test_1234567890_abc123
Callback ID: 456
Console Errors: [
  {
    "message": "WebSocket connection failed",
    "timestamp": "2024-01-15T10:30:00.000Z"
  }
]
```

### ğŸ“ˆ MÃ©tricas de Rendimiento
```json
{
  "browser": "webkit",
  "viewport": {"width": 390, "height": 844},
  "loadTime": 3500,
  "callbackTime": 12000,
  "successRate": 0.8,
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

## ğŸš¨ Alertas y MonitorizaciÃ³n

### CI/CD Integration
- **GitHub Actions** ejecuta tests automÃ¡ticamente
- **Health checks** cada 15 minutos
- **Full tests** en cada push a main
- **Stress tests** bajo demanda

### Sistema de Alertas
- **Issues automÃ¡ticos** en GitHub cuando fallan tests crÃ­ticos
- **Slack notifications** (configurable)
- **Email reports** con mÃ©tricas detalladas

## ğŸ› ï¸ Troubleshooting

### Problema: Tests fallan en Safari mÃ³vil
**SoluciÃ³n:**
1. Verificar que el polling estÃ© activado
2. Aumentar timeouts en `test-config.js`
3. Revisar logs de WebSocket en consola

### Problema: Timeouts frecuentes
**SoluciÃ³n:**
1. Verificar conectividad a Supabase
2. Comprobar latencia de red
3. Ajustar `CALLBACK_TIMEOUT` en configuraciÃ³n

### Problema: Muchos fallos aleatorios
**SoluciÃ³n:**
1. Ejecutar con `--workers 1` (sin paralelizaciÃ³n)
2. AÃ±adir delays entre tests
3. Verificar memoria disponible

## ğŸ“ Comandos Ãštiles

```bash
# Tests con navegador visible para debugging
npm run test:headed

# Tests con UI interactiva de Playwright
npm run test:ui

# Ver Ãºltimo reporte HTML
npm run test:report

# Test especÃ­fico en un dispositivo
npx playwright test --project="Mobile Safari iPhone"

# Test con mÃ¡ximo logging
npx playwright test --debug

# Limpiar resultados anteriores
rm -rf test-results/ playwright-report/ qa-reports/
```

## ğŸ”„ Mantenimiento

### ActualizaciÃ³n de Dispositivos
Editar `playwright.config.js` para aÃ±adir nuevos dispositivos:
```javascript
{
  name: 'Nuevo Dispositivo',
  use: { ...devices['Device Name'] }
}
```

### ActualizaciÃ³n de Tests
Modificar archivos en `tests/` segÃºn nuevas funcionalidades del chatbot.

### MonitorizaciÃ³n Continua
El sistema estÃ¡ configurado para ejecutarse automÃ¡ticamente:
- **Cada hora**: Tests de monitorizaciÃ³n
- **Cada push**: Tests completos
- **Cada PR**: Tests rÃ¡pidos

## ğŸ“ Soporte

Si encuentras problemas o necesitas ayuda:

1. **Revisar logs** en `test-results/`
2. **Consultar documentaciÃ³n** de Playwright
3. **Ejecutar tests** en modo debug
4. **Verificar configuraciÃ³n** de Supabase

---

## ğŸ¯ MÃ©tricas de Ã‰xito

- **95%+ de Ã©xito** en tests de monitorizaciÃ³n
- **0 fallos crÃ­ticos** no detectados
- **< 30s** tiempo promedio de callback
- **< 15s** tiempo de carga de pÃ¡gina

Â¡El sistema estÃ¡ diseÃ±ado para mantener la calidad del chatbot Luci en todos los dispositivos! ğŸš€
